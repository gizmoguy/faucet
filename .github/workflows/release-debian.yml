name: Build debian packages and images for release

on:
  release:
    types:
      - published

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  rpi-image:
    name: "Build raspberry pi image"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y upgrade
          sudo apt-get install -y binfmt-support
          sudo /usr/sbin/update-binfmts --enable
          sudo modprobe nbd
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Install pi-gen
        run: |
          cd images/raspbian/
          git clone https://github.com/RPi-Distro/pi-gen.git
          cd pi-gen
          mv ../install-faucet.sh ./stage2/01-sys-tweaks/02-install-faucet.sh
      - name: Build image
        run: |
          cd images/raspbian/pi-gen/
          echo "IMG_NAME='faucet_${{ github.event.release.tag_name }}_raspbian'" > config
          touch ./stage3/SKIP ./stage4/SKIP ./stage5/SKIP
          touch ./stage4/SKIP_IMAGES ./stage5/SKIP_IMAGES
          ./build-docker.sh
          mv ./deploy/image_*_raspbian-lite.zip ./deploy/faucet_${{ github.event.release.tag_name }}_raspbian-lite.zip
      - name: Upload release asset
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          overwrite: true
          file: ./images/raspbian/pi-gen/deploy/faucet_${{ github.event.release.tag_name }}_raspbian-lite.zip
          asset_name: faucet_${{ github.event.release.tag_name }}_raspbian-lite.zip
